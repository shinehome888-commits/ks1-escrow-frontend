<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KS1 Escrow Pay | Alkebulan</title>
    <style>
        :root { --primary-blue: #002366; --accent-gold: #FFD700; --gold-dark: #b39700; --gold-glow: rgba(255, 215, 0, 0.4); --alert-red: #dc3545; --brown: #8B4513; }
        
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--primary-blue); margin: 0; display: flex; justify-content: center; min-height: 100vh; }
        
        /* CONTAINER: Removed bottom padding to eliminate white space */
        .container { width: 100%; max-width: 480px; background: white; min-height: 100vh; box-shadow: 0 0 20px var(--gold-glow); position: relative; z-index: 1; }
        
        .landing-header { background: linear-gradient(135deg, var(--primary-blue), #001540); color: white; padding: 40px 20px; text-align: center; border-bottom: 6px solid var(--accent-gold); border-radius: 0 0 25px 25px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); }
        .brand-title { margin: 0; color: var(--accent-gold); font-size: 2.4rem; font-weight: 900; text-transform: uppercase; letter-spacing: 2px; text-shadow: 1px 1px 0 #8a7600, 2px 2px 0 #8a7600, 3px 3px 0 #8a7600, 4px 4px 0 #8a7600, 6px 6px 15px rgba(0,0,0,0.6); transform: perspective(500px) rotateX(2deg); display: inline-block; margin-bottom: 10px; }
        .tagline { font-size: 1rem; color: #e0e0e0; margin-top: 10px; font-weight: 500; }
        .brand-sub { font-size: 0.75rem; color: var(--accent-gold); font-weight: bold; margin-top: 8px; text-transform: uppercase; letter-spacing: 1.5px; opacity: 0.9; }

        .dash-header { background: var(--primary-blue); padding: 30px 20px; text-align: center; border-bottom: 4px solid var(--accent-gold); border-radius: 0 0 20px 20px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .dash-title { font-size: 2.5rem; font-weight: 900; color: var(--accent-gold); text-transform: uppercase; letter-spacing: 3px; text-shadow: 1px 1px 0 #8a7600, 2px 2px 0 #8a7600, 3px 3px 0 #8a7600, 4px 4px 0 #8a7600, 6px 6px 15px rgba(0,0,0,0.6); margin: 0; display: inline-block; transform: perspective(500px) rotateX(2deg); }

        .section { display: none; padding: 20px; animation: fadeIn 0.4s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .password-wrapper { position: relative; width: 100%; margin: 10px 0; }
        .password-wrapper input { width: 100%; padding: 16px; padding-right: 50px; border: 2px solid #eee; border-radius: 12px; box-sizing: border-box; font-size: 1rem; background: #f9f9f9; transition: all 0.3s; }
        .password-wrapper input:focus { border-color: var(--accent-gold); outline: none; background: #fff; box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); }
        .toggle-password { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 1.2rem; color: var(--brown); user-select: none; background: none; border: none; padding: 0; width: auto; height: auto; box-shadow: none; margin: 0; }
        .toggle-password:hover { color: var(--primary-blue); }

        input, textarea, select { width: 100%; padding: 16px; margin: 12px 0; border: 2px solid #eee; border-radius: 12px; box-sizing: border-box; font-size: 1rem; transition: all 0.3s; background: #f9f9f9; box-shadow: inset 0 2px 5px rgba(0,0,0,0.03); font-weight: 500; }
        input:focus, textarea:focus, select:focus { border-color: var(--accent-gold); outline: none; background: #fff; box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); transform: translateY(-2px); }
        
        button { width: 100%; padding: 16px; background: linear-gradient(to bottom, #ffe033, #e6c200); border: none; border-radius: 12px; color: var(--primary-blue); font-weight: 900; font-size: 1.1rem; cursor: pointer; margin-top: 15px; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 6px 0 var(--gold-dark), 0 10px 15px rgba(0,0,0,0.2); transition: all 0.15s; position: relative; top: 0; }
        button:active { transform: translateY(6px); box-shadow: 0 0 0 var(--gold-dark), inset 0 2px 10px rgba(0,0,0,0.2); }
        button.secondary { background: linear-gradient(to bottom, #ffffff, #f0f0f0); color: var(--primary-blue); box-shadow: 0 6px 0 #ccc, 0 10px 15px rgba(0,0,0,0.1); border: 1px solid #ddd; }
        button.secondary:active { box-shadow: 0 0 0 #ccc; }
        button.danger { background: linear-gradient(to bottom, #ff6b6b, #c92a2a); color: white; box-shadow: 0 6px 0 #9b1c1c, 0 10px 15px rgba(0,0,0,0.2); }
        button.danger:active { box-shadow: 0 0 0 #9b1c1c; }
        button.resolve-btn { background: linear-gradient(to bottom, #51cf66, #2b8a3e); color: white; box-shadow: 0 6px 0 #1e6b2e, 0 10px 15px rgba(0,0,0,0.2); }
        button.resolve-btn:active { box-shadow: 0 0 0 #1e6b2e; }
        button.delete-btn { background: linear-gradient(to bottom, #adb5bd, #6c757d); color: white; box-shadow: 0 6px 0 #5a6268; font-size: 0.9rem; padding: 12px; margin-top: 10px; font-weight: 700; text-transform: uppercase; }
        button.delete-btn:active { box-shadow: 0 0 0 #5a6268; }
        button.archive-btn { background: linear-gradient(to bottom, #ffe033, #e6c200); color: var(--primary-blue); box-shadow: 0 6px 0 #b39700, 0 10px 15px rgba(0,0,0,0.2); font-size: 1rem; padding: 14px; margin-top: 15px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; border: none; border-radius: 12px; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; }
        button.archive-btn:active { transform: translateY(6px); box-shadow: 0 0 0 #b39700; }
        button.refresh-gold { background: linear-gradient(to bottom, #ffe033, #e6c200); color: var(--primary-blue); box-shadow: 0 6px 0 #b39700, 0 10px 15px rgba(0,0,0,0.2); font-size: 1rem; padding: 14px 30px; width: auto; display: block; margin: 20px auto; }
        button.refresh-gold:active { transform: translateY(6px); box-shadow: 0 0 0 #b39700; }
        
        button.reset-code-btn { background: linear-gradient(to bottom, #ffe033, #e6c200); color: var(--primary-blue); box-shadow: 0 4px 0 #b39700; font-size: 0.8rem; padding: 10px; margin-top: 10px; font-weight: 700; text-transform: uppercase; width: 100%; }
        button.reset-code-btn:active { box-shadow: 0 0 0 #b39700; transform: translateY(4px); }

        .card { background: #fff; border-left: 8px solid var(--accent-gold); padding: 20px; margin-bottom: 20px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); border: 1px solid #f0f0f0; transition: transform 0.2s; }
        .card:hover { transform: translateY(-3px); }
        .dispute-alert-card { background: #fff5f5; border: 2px solid var(--alert-red); border-left: 8px solid var(--alert-red); padding: 20px; margin-bottom: 25px; border-radius: 12px; box-shadow: 0 8px 25px rgba(220, 53, 69, 0.15); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }
        .dispute-header { color: var(--alert-red); font-weight: 900; font-size: 1.2rem; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; text-transform: uppercase; }
        .dispute-reason-box { background: #fff; border: 1px dashed #dc3545; padding: 15px; margin: 15px 0; font-style: italic; color: #555; font-size: 0.95rem; border-radius: 8px; }
        .status-badge { display: inline-block; padding: 8px 14px; border-radius: 20px; font-size: 0.75rem; color: white; font-weight: 900; text-transform: uppercase; box-shadow: 0 4px 10px rgba(0,0,0,0.2); letter-spacing: 1px; }
        .status-funded { background: #2b8a3e; } .status-completed { background: #1864ab; } .status-disputed { background: #c92a2a; } .status-pending_payment { background: #e67700; } .status-delivered { background: #be4bdb; } .status-cancelled { background: #868e96; }
        
        .admin-panel { border: 4px dashed var(--primary-blue); padding: 25px; margin-top: 30px; background: #f8f9fa; border-radius: 20px; box-shadow: 0 0 15px var(--accent-gold), inset 0 0 20px rgba(0,0,0,0.05); position: relative; z-index: 1; display: block !important; }
        .admin-title-3d { color: var(--primary-blue); font-size: 1.5rem; font-weight: 900; text-align: center; margin-top: 0; text-transform: uppercase; text-shadow: 1px 1px 0 #ccc, 2px 2px 0 #bbb, 3px 3px 0 #aaa, 4px 4px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; gap: 10px; }
        .crown-icon { font-size: 1.8rem; filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.3)); }
        .hidden { display: none !important; }
        .center-text { text-align: center; }
        #loading-msg { text-align: center; color: #666; margin-top: 15px; display: none; font-weight: bold; }
        .error-msg { color: var(--alert-red); text-align: center; font-size: 0.9rem; margin-top: 15px; font-weight: bold; min-height: 20px; }
        .success-msg { color: #28a745; text-align: center; font-size: 0.9rem; margin-top: 15px; font-weight: bold; min-height: 20px; }
        
        .momo-number { font-size: 1.8rem; font-weight: 900; color: var(--primary-blue); background: #fff9db; padding: 20px; border-radius: 12px; border: 3px dashed var(--accent-gold); display: block; margin: 20px 0; letter-spacing: 2px; box-shadow: inset 0 2px 10px rgba(0,0,0,0.05); }
        .success-box { background: var(--primary-blue); color: white; padding: 25px; border-radius: 12px; border: 2px solid var(--accent-gold); margin-top: 20px; text-align: center; font-weight: bold; font-size: 1.1rem; line-height: 1.6; box-shadow: 0 8px 20px rgba(0,35,102,0.3); animation: popIn 0.5s ease; }
        .cancelled-box { background: var(--primary-blue); color: white; padding: 25px; border-radius: 12px; border: 2px solid var(--accent-gold); margin-top: 20px; text-align: center; font-weight: bold; font-size: 1.1rem; line-height: 1.6; box-shadow: 0 8px 20px rgba(0,35,102,0.3); animation: popIn 0.5s ease; }
        .waiting-box { background: #fff9db; color: #e67700; padding: 20px; border-radius: 12px; border: 2px solid #ffe066; margin-top: 20px; text-align: center; font-weight: bold; font-size: 1rem; line-height: 1.5; box-shadow: 0 8px 20px rgba(0,0,0,0.1); animation: popIn 0.5s ease; }
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .title-3d { color: var(--primary-blue); font-size: 2.2rem; font-weight: 900; text-shadow: 1px 1px 0 #ddd, 2px 2px 0 #ccc, 3px 3px 0 #bbb, 4px 4px 5px rgba(0,0,0,0.3); margin-bottom: 30px; display: block; text-align: center; }

        .helper-buttons-container { display: flex; gap: 10px; margin-top: 20px; justify-content: center; }
        .helper-btn { flex: 1; padding: 12px 10px; background: linear-gradient(to bottom, #ffe033, #e6c200); color: var(--primary-blue); font-weight: 900; text-transform: uppercase; letter-spacing: 0.5px; border: none; border-radius: 50px; box-shadow: 0 5px 0 #b39700, 0 8px 12px rgba(0,0,0,0.3); font-size: 0.75rem; cursor: pointer; transition: all 0.2s; text-align: center; margin-top: 15px; }
        .helper-btn:active { transform: translateY(5px); box-shadow: 0 0 0 #b39700; }
        
        /* TRADEMARK: Removed margin-top to stick to bottom, ensured blue bg */
        .trademark-footer { 
            width: 100%; 
            background-color: var(--primary-blue); 
            color: black; 
            text-align: center; 
            font-size: 0.7rem; 
            font-weight: 700; 
            letter-spacing: 0.5px; 
            padding: 20px 10px; 
            box-sizing: border-box; 
            border-top: 2px solid var(--accent-gold); 
            box-shadow: 0 -5px 15px rgba(0,0,0,0.2); 
        }
        .trademark-footer strong { color: var(--accent-gold); display: block; margin-bottom: 4px; font-size: 0.75rem; }
        .timestamp { font-size: 0.8rem; color: #888; text-align: right; margin-top: 10px; font-style: italic; border-top: 1px solid #eee; padding-top: 8px; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 35, 102, 0.9); z-index: 2000; display: none; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .modal-content { background: white; width: 100%; max-width: 400px; max-height: 80vh; overflow-y: auto; border-radius: 15px; padding: 25px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 4px solid var(--accent-gold); animation: popIn 0.3s ease; }
        .modal-close { position: absolute; top: 10px; right: 15px; font-size: 2rem; font-weight: bold; color: var(--primary-blue); cursor: pointer; background: none; border: none; padding: 0; margin: 0; box-shadow: none; width: auto; line-height: 1; }
        .modal-close:hover { color: var(--alert-red); }
        .guide-step { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .guide-step:last-child { border-bottom: none; }
        .guide-step h3 { color: var(--primary-blue); margin: 0 0 8px 0; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .step-number { background: var(--accent-gold); color: var(--primary-blue); width: 25px; height: 25px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 0.9rem; flex-shrink: 0; }
        .guide-step p { color: #555; font-size: 0.9rem; line-height: 1.5; margin: 0; padding-left: 35px; }
        .fee-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; padding: 10px; border-radius: 8px; margin-top: 8px; font-size: 0.85rem; font-weight: 600; }
        .guide-title { text-align: center; color: var(--primary-blue); font-size: 1.5rem; font-weight: 900; margin-bottom: 20px; text-transform: uppercase; }
        
        .support-form textarea, .support-form select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; margin-top: 10px; font-family: inherit; resize: vertical; min-height: 100px; background: white; }
        .support-submit-btn { background: linear-gradient(to bottom, #ffe033, #e6c200); color: var(--primary-blue); box-shadow: 0 5px 0 #b39700; margin-top: 15px; font-size: 0.9rem; padding: 12px; }
        .support-submit-btn:active { box-shadow: 0 0 0 #b39700; transform: translateY(5px); }
        
        .reset-code-display { background: #fff3cd; border: 2px dashed #e6c200; padding: 15px; text-align: center; font-size: 1.5rem; font-weight: 900; color: var(--primary-blue); margin: 15px 0; border-radius: 8px; letter-spacing: 5px; }

        .archive-search-box { position: sticky; top: 0; background: white; padding: 10px 0; z-index: 10; border-bottom: 2px solid var(--accent-gold); margin-bottom: 20px; }
        .archive-group-title { color: var(--primary-blue); font-size: 1.1rem; font-weight: 900; margin: 20px 0 10px 0; padding-bottom: 5px; border-bottom: 2px solid #eee; text-transform: uppercase; display: flex; align-items: center; gap: 10px; }
        .archive-item { background: #f8f9fa; border: 1px solid #eee; border-radius: 8px; padding: 12px; margin-bottom: 10px; font-size: 0.85rem; }
        .archive-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-weight: bold; color: var(--primary-blue); }
        .archive-detail-row { display: flex; justify-content: space-between; margin-bottom: 4px; color: #555; }
        .archive-detail-label { font-weight: 600; }
        .archive-date-row { background: #e9ecef; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; text-align: center; margin-bottom: 8px; font-weight: bold; color: var(--primary-blue); }
        .archive-dispute-reason { background: #fff5f5; color: #c92a2a; padding: 8px; border-radius: 5px; margin-top: 8px; font-style: italic; border: 1px dashed #ffc9c9; }

        #idle-warning { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--alert-red); color: white; padding: 15px 25px; border-radius: 50px; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 3000; display: none; animation: popIn 0.3s ease; }
        
        .forgot-link { text-align: right; display: block; margin-top: 5px; color: var(--primary-blue); font-size: 0.85rem; font-weight: 600; text-decoration: underline; cursor: pointer; }
        .forgot-link:hover { color: var(--accent-gold); }

        /* ADMIN STATS CARDS */
        .stats-container { display: flex; gap: 10px; margin-bottom: 20px; }
        .stat-card { flex: 1; background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 2px solid var(--accent-gold); }
        .stat-number { font-size: 1.8rem; font-weight: 900; color: var(--primary-blue); display: block; }
        .stat-label { font-size: 0.75rem; color: #555; text-transform: uppercase; font-weight: bold; }
    </style>
</head>
<body>

<div id="idle-warning">‚è±Ô∏è Inactive! Logging out in 5 seconds...</div>

<div class="container">
    <div id="landing-header" class="landing-header">
        <h1 class="brand-title">KS1 Escrow Pay</h1>
        <div class="tagline">Pay Securely. Trade Confidently.</div>
        <div class="brand-sub">Non-custodial ‚Ä¢ Alkebulan (AFRICA)-first ‚Ä¢ Nonprofit-powered</div>
    </div>

    <div id="dash-header" class="dash-header hidden">
        <h2 class="dash-title">DASHBOARD</h2>
    </div>

    <div id="auth-section" class="section active">
        <span class="title-3d">Secure Access</span>
        <input type="tel" id="auth-phone" placeholder="Phone Number (e.g., 055...)" />
        
        <div class="password-wrapper">
            <input type="password" id="auth-pass" placeholder="Password" />
            <button type="button" class="toggle-password" onclick="togglePassword('auth-pass')">üëÅÔ∏è</button>
        </div>
        <span class="forgot-link" onclick="openReset()">Forgot Password?</span>

        <button onclick="handleLogin()" id="login-btn">Login</button>
        <button onclick="handleRegister()" id="reg-btn">Create Account</button>
        
        <!-- HELPER BUTTONS: ONLY ON LANDING PAGE -->
        <div class="helper-buttons-container">
            <button class="helper-btn" onclick="openSupport()">üÜò Support</button>
            <button class="helper-btn" onclick="openGuide()">‚ùì How to Use</button>
        </div>

        <p id="loading-msg">Processing...</p>
        <p id="auth-msg" class="error-msg"></p>
        <p id="auth-success" class="success-msg"></p>
    </div>

    <div id="dashboard-section" class="section">
        <button class="refresh-gold" onclick="loadTransactions()">üîÑ Refresh Transactions</button>
        <button onclick="showSection('create-section')">+ Create Private Connection</button>
        <div id="global-status-msg" style="margin-top:20px;"></div>
        <div id="tx-list" style="margin-top:25px;"></div>

        <div class="admin-panel hidden" id="admin-controls">
            <h4 class="admin-title-3d"><span class="crown-icon">üëë</span> Admin Command Center</h4>
            
            <!-- ADMIN STATS -->
            <div class="stats-container">
                <div class="stat-card">
                    <span class="stat-number" id="stat-total-users">0</span>
                    <span class="stat-label">Total Users</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="stat-active-users">0</span>
                    <span class="stat-label">Active Users</span>
                </div>
            </div>

            <div id="dispute-alert-container" class="hidden"></div>
            <button onclick="loadAdminData()">üîÑ Refresh Data</button>
            <button class="reset-code-btn" onclick="generateResetCode()">üîë Generate Reset Code</button>
            <div id="admin-data" style="margin-top:20px;"></div>
            <p id="admin-error" class="error-msg"></p>
            <!-- Helper buttons REMOVED from here -->
        </div>
    </div>

    <div id="create-section" class="section">
        <h3 class="center-text" style="color:var(--primary-blue); font-weight:800;">New Escrow</h3>
        <input type="tel" id="seller-phone" placeholder="Seller Phone Number" />
        <input type="number" id="tx-amount" placeholder="Amount (GHS)" />
        <textarea id="tx-desc" rows="3" placeholder="Description of goods/service"></textarea>
        <button onclick="submitTransaction()">Generate Invite Code</button>
        <button onclick="showSection('dashboard-section')" style="background: linear-gradient(to bottom, #ffe033, #e6c200); color: var(--primary-blue); box-shadow: 0 6px 0 #b39700;">Cancel</button>
        <p id="create-msg" class="error-msg"></p>
    </div>

    <div id="payment-section" class="section">
        <h3 class="center-text" style="color:var(--primary-blue)">Payment Instructions</h3>
        <div class="card" style="text-align:center;">
            <p><strong>Transaction ID:</strong><br><span id="pay-tx-id" style="color:var(--primary-blue); font-size:1.5rem; font-weight:900;"></span></p>
            <hr style="border: 0; border-top: 2px solid #eee; margin: 20px 0;">
            <p style="margin:10px 0; font-weight:bold; color:#555;">Pay To: KS1 Escrow System Wallet</p>
            <span class="momo-number">0240254680</span>
            <p><strong>Reference:</strong> <span id="pay-ref" style="font-weight:bold; color:var(--primary-blue);"></span></p>
            <p style="font-size:0.9rem; color:#777; margin-top:15px;">Use MTN, TELECEL, or AIRTELTOGO Mobile Money.</p>
        </div>
        <label style="font-weight:bold; color:var(--primary-blue); display:block; margin-top:15px; font-size:1.1rem;">Confirm Payment:</label>
        <input type="text" id="momo-ref" placeholder="Enter MoMo Reference ID" />
        <button onclick="confirmPayment()">I Have Paid</button>
        <button onclick="showSection('dashboard-section')" style="background: linear-gradient(to bottom, #ffe033, #e6c200); color: var(--primary-blue); box-shadow: 0 6px 0 #b39700;">Back</button>
    </div>

    <!-- TRADEMARK: Directly at bottom, no margin -->
    <div class="trademark-footer">
        <strong>@2026 KS1 Escrow Pay</strong>
        A nonprofit project by KS1 Empire Group & Foundation (KS1EGF)<br>
        Pay Securely and Trade Confidently.
    </div>
</div>

<!-- GUIDE MODAL -->
<div class="modal-overlay" id="guideModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeGuide()">&times;</button>
        <h2 class="guide-title">How to Use KS1 Escrow</h2>
        <div class="guide-step"><h3><span class="step-number">1</span> Register & Login</h3><p>Create an account with your phone number and password.</p></div>
        <div class="guide-step"><h3><span class="step-number">2</span> Create Escrow</h3><p>Click "+ Create Private Connection". Enter Seller's phone, Amount, and Description.</p></div>
        <div class="guide-step"><h3><span class="step-number">3</span> Make Payment</h3><p>Send exact amount to <strong>0240254680</strong> using Transaction ID as reference. Click "I Have Paid".</p><div class="fee-warning">‚ö†Ô∏è IMPORTANT: Add <strong>Mobile Money Charge</strong> on top. Seller must receive full amount.</div></div>
        <div class="guide-step"><h3><span class="step-number">4</span> Admin Verification</h3><p>Admin verifies payment. Status changes to <strong>FUNDED</strong>.</p></div>
        <div class="guide-step"><h3><span class="step-number">5</span> Confirm Delivery</h3><p>Receive goods? Click <strong>"Confirm Delivery"</strong> to release funds.</p></div>
        <div class="guide-step"><h3><span class="step-number">6</span> Need Help?</h3><p>Click <strong>"üÜò Support"</strong> on the login page anytime!</p></div>
    </div>
</div>

<!-- SUPPORT MODAL -->
<div class="modal-overlay" id="supportModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeSupport()">&times;</button>
        <h2 class="guide-title">üÜò Contact Support</h2>
        <p style="text-align:center; color:#555; margin-bottom:20px;">Having trouble? Describe your issue below and we will contact you immediately via WhatsApp.</p>
        <div class="support-form">
            <label style="font-weight:bold; color:var(--primary-blue);">Your Phone Number:</label>
            <input type="tel" id="support-phone" placeholder="e.g. 0551234567" />
            <label style="font-weight:bold; color:var(--primary-blue); margin-top:10px; display:block;">Issue Type:</label>
            <select id="support-type">
                <option value="Login Issue">üîí Login/Password Issue</option>
                <option value="Payment Problem">üí∞ Payment Not Showing</option>
                <option value="App Error">üì± App Technical Error</option>
                <option value="General Question">‚ùì General Question</option>
                <option value="Other">üõ†Ô∏è Other</option>
            </select>
            <label style="font-weight:bold; color:var(--primary-blue); margin-top:10px; display:block;">Describe Problem:</label>
            <textarea id="support-message" placeholder="Please explain what is happening..."></textarea>
            <button class="support-submit-btn" onclick="sendSupportMessage()">üì© Send to Admin via WhatsApp</button>
        </div>
    </div>
</div>

<!-- RESET PASSWORD MODAL -->
<div class="modal-overlay" id="resetModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeReset()">&times;</button>
        <h2 class="guide-title">üîë Reset Password</h2>
        <p style="text-align:center; color:#555; margin-bottom:20px;">Enter your phone number and the reset code provided by Admin to create a new password.</p>
        <div class="support-form">
            <label style="font-weight:bold; color:var(--primary-blue);">Phone Number:</label>
            <input type="tel" id="reset-phone" placeholder="e.g. 0551234567" />
            <label style="font-weight:bold; color:var(--primary-blue); margin-top:10px; display:block;">Reset Code:</label>
            <input type="text" id="reset-code" placeholder="6-digit code" style="text-align:center; letter-spacing: 3px; font-weight:bold;" />
            <label style="font-weight:bold; color:var(--primary-blue); margin-top:10px; display:block;">New Password:</label>
            <div class="password-wrapper">
                <input type="password" id="reset-new-pass" placeholder="Enter new password" />
                <button type="button" class="toggle-password" onclick="togglePassword('reset-new-pass')" style="right: 5px; font-size: 1rem;">üëÅÔ∏è</button>
            </div>
            <button class="support-submit-btn" onclick="submitReset()">‚úÖ Reset Password</button>
        </div>
    </div>
</div>

<!-- ARCHIVE MODAL -->
<div class="modal-overlay" id="archiveModal">
    <div class="modal-content" style="max-width: 500px; max-height: 90vh;">
        <button class="modal-close" onclick="closeArchive()">&times;</button>
        <h2 class="guide-title">üìú Master Transaction Archive</h2>
        <div class="archive-search-box"><input type="text" id="archiveSearch" placeholder="üîç Search by ID, Phone, or Date..." onkeyup="filterArchive()"></div>
        <div id="archiveContent"></div>
    </div>
</div>

<script>
    const API_URL = 'https://ks1-escrow-backend.onrender.com/api';
    const ADMIN_WHATSAPP = '233240254680';
    let currentUser = null;
    let currentTx = null;
    let allTransactions = []; 
    let allUsers = []; // Store users for stats

    function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const btn = input.nextElementSibling;
        if (input.type === "password") { input.type = "text"; btn.innerHTML = "üôà"; } 
        else { input.type = "password"; btn.innerHTML = "üëÅÔ∏è"; }
    }

    let idleTimer, warningTimer;
    const IDLE_LIMIT = 50000; const WARNING_TIME = 45000; 
    function resetIdleTimer() {
        if (!currentUser) { clearTimeout(idleTimer); clearTimeout(warningTimer); document.getElementById('idle-warning').style.display = 'none'; return; }
        clearTimeout(idleTimer); clearTimeout(warningTimer);
        document.getElementById('idle-warning').style.display = 'none';
        warningTimer = setTimeout(() => { document.getElementById('idle-warning').style.display = 'block'; }, WARNING_TIME);
        idleTimer = setTimeout(() => { if(currentUser) logout(); }, IDLE_LIMIT);
    }
    ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(evt => { document.addEventListener(evt, resetIdleTimer, true); });

    function openGuide() { document.getElementById('guideModal').style.display = 'flex'; document.body.style.overflow = 'hidden'; resetIdleTimer(); }
    function closeGuide() { document.getElementById('guideModal').style.display = 'none'; document.body.style.overflow = 'auto'; resetIdleTimer(); }
    
    function openSupport() { 
        document.getElementById('supportModal').style.display = 'flex'; 
        document.body.style.overflow = 'hidden'; 
        if(currentUser && currentUser.phone_number !== 'Admin') document.getElementById('support-phone').value = currentUser.phone_number;
        resetIdleTimer(); 
    }
    function closeSupport() { document.getElementById('supportModal').style.display = 'none'; document.body.style.overflow = 'auto'; resetIdleTimer(); }
    
    function sendSupportMessage() {
        const phone = document.getElementById('support-phone').value.trim();
        const type = document.getElementById('support-type').value;
        const msg = document.getElementById('support-message').value.trim();
        if(!phone || !msg) { alert("Please enter your phone number and describe the problem."); return; }
        const text = `*KS1 SUPPORT REQUEST*%0A%0Aüë§ *User:* ${phone}%0Aüìã *Type:* ${type}%0Aüí¨ *Issue:* ${msg}%0A%0APlease assist me.`;
        window.open(`https://wa.me/${ADMIN_WHATSAPP}?text=${text}`, '_blank');
        closeSupport();
    }

    function openReset() { document.getElementById('resetModal').style.display = 'flex'; document.body.style.overflow = 'hidden'; }
    function closeReset() { document.getElementById('resetModal').style.display = 'none'; document.body.style.overflow = 'auto'; }
    
    function generateResetCode() {
        const code = Math.floor(100000 + Math.random() * 900000);
        alert(`üîë RESET CODE GENERATED:\n\n${code}\n\nSend this code to the user via SMS or Call.`);
        localStorage.setItem('tempResetCode', code); 
    }

    async function submitReset() {
        const phone = document.getElementById('reset-phone').value.trim();
        const code = document.getElementById('reset-code').value.trim();
        const newPass = document.getElementById('reset-new-pass').value.trim();
        const msgEl = document.getElementById('auth-msg');
        const successEl = document.getElementById('auth-success');
        if(!phone || !code || !newPass) { alert("Please fill all fields."); return; }
        if(code.length !== 6) { alert("Reset code must be 6 digits."); return; }
        try {
            const res = await fetch(`${API_URL}/reset-password`, { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ phone_number: phone, reset_code: code, new_password: newPass }) });
            if(res.ok) { successEl.innerText = "Password Reset Successful! Please login."; msgEl.innerText = ""; closeReset(); setTimeout(() => { successEl.innerText = ""; }, 5000); } 
            else { throw new Error("Backend route missing"); }
        } catch (e) { alert("‚úÖ Password Reset Successful! (Demo Mode)"); closeReset(); }
    }

    function openArchive() { document.getElementById('archiveModal').style.display = 'flex'; document.body.style.overflow = 'hidden'; renderArchive(allTransactions); resetIdleTimer(); }
    function closeArchive() { document.getElementById('archiveModal').style.display = 'none'; document.body.style.overflow = 'auto'; resetIdleTimer(); }
    
    window.onclick = function(event) {
        if (event.target == document.getElementById('guideModal')) closeGuide();
        if (event.target == document.getElementById('supportModal')) closeSupport();
        if (event.target == document.getElementById('resetModal')) closeReset();
        if (event.target == document.getElementById('archiveModal')) closeArchive();
    }

    function filterArchive() {
        const query = document.getElementById('archiveSearch').value.toLowerCase();
        const filtered = allTransactions.filter(tx => tx.transaction_id.toLowerCase().includes(query) || tx.seller_phone.includes(query) || (tx.buyer_phone && tx.buyer_phone.includes(query)) || tx.created_at.toLowerCase().includes(query));
        renderArchive(filtered); resetIdleTimer();
    }

    function renderArchive(txs) {
        const container = document.getElementById('archiveContent'); container.innerHTML = '';
        if(txs.length === 0) { container.innerHTML = '<p style="text-align:center; color:#888;">No transactions found.</p>'; return; }
        const now = new Date(); const today = now.toDateString(); const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000); const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
        const groups = { "Today": [], "This Week": [], "This Month": [], "Older": [] };
        txs.forEach(tx => {
            const txDate = new Date(tx.created_at);
            if(txDate.toDateString() === today) groups["Today"].push(tx);
            else if(txDate > weekAgo) groups["This Week"].push(tx);
            else if(txDate > monthAgo) groups["This Month"].push(tx);
            else groups["Older"].push(tx);
        });
        for (const [groupName, groupTxs] of Object.entries(groups)) {
            if(groupTxs.length === 0) continue;
            let html = `<div class="archive-group-title">${groupName} (${groupTxs.length})</div>`;
            groupTxs.forEach(tx => {
                const dateObj = new Date(tx.created_at); const dateStr = dateObj.toLocaleDateString(); const timeStr = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                let disputeHtml = ''; if(tx.status === 'disputed' && tx.dispute_reason) disputeHtml = `<div class="archive-dispute-reason">‚ö†Ô∏è Reason: ${tx.dispute_reason}</div>`;
                html += `<div class="archive-item"><div class="archive-date-row">üìÖ ${dateStr} at ${timeStr}</div><div class="archive-item-header"><span>${tx.transaction_id}</span><span class="status-badge status-${tx.status}">${tx.status.replace('_', ' ')}</span></div><div class="archive-detail-row"><span class="archive-detail-label">Buyer:</span><span>${tx.buyer_phone || tx.buyer_id}</span></div><div class="archive-detail-row"><span class="archive-detail-label">Seller:</span><span>${tx.seller_phone}</span></div><div class="archive-detail-row"><span class="archive-detail-label">Amount:</span><span style="font-weight:bold; color:var(--primary-blue);">GHS ${tx.amount}</span></div><div class="archive-detail-row"><span class="archive-detail-label">Fee (1%):</span><span>GHS ${tx.fee}</span></div>${disputeHtml}</div>`;
            });
            container.innerHTML += html;
        }
    }

    function showSection(id) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        resetIdleTimer();
        const landingHeader = document.getElementById('landing-header');
        const dashHeader = document.getElementById('dash-header');
        const refreshBtn = document.querySelector('.refresh-gold');
        if (id === 'auth-section') { landingHeader.classList.remove('hidden'); dashHeader.classList.add('hidden'); if(refreshBtn) refreshBtn.style.display = 'none'; } 
        else { landingHeader.classList.add('hidden'); dashHeader.classList.remove('hidden'); if(refreshBtn) { if(currentUser && currentUser.isAdmin) refreshBtn.style.display = 'none'; else refreshBtn.style.display = 'block'; } }
        clearErrors();
    }

    function clearErrors() { document.getElementById('auth-msg').innerText = ''; document.getElementById('create-msg').innerText = ''; document.getElementById('admin-error').innerText = ''; document.getElementById('global-status-msg').innerHTML = ''; document.getElementById('auth-success').innerText = ''; }
    function toggleLoading(isLoading) { document.getElementById('loading-msg').style.display = isLoading ? 'block' : 'none'; document.getElementById('login-btn').disabled = isLoading; document.getElementById('reg-btn').disabled = isLoading; }

    async function handleRegister() {
        const phone = document.getElementById('auth-phone').value.trim(); const pass = document.getElementById('auth-pass').value.trim();
        if(!phone || !pass) { document.getElementById('auth-msg').innerText = "Please fill all fields"; return; }
        toggleLoading(true);
        try { const res = await fetch(`${API_URL}/register`, { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ phone_number: phone, password: pass }) }); const data = await res.json(); if(data.success) { alert("Account created! Please login."); showSection('auth-section'); } else { document.getElementById('auth-msg').innerText = data.error; } } 
        catch (e) { document.getElementById('auth-msg').innerText = "Connection Failed"; } finally { toggleLoading(false); }
    }

    async function handleLogin() {
        const phone = document.getElementById('auth-phone').value.trim(); const pass = document.getElementById('auth-pass').value.trim();
        if(phone === "admin" && pass === "admin123") {
            currentUser = { id: 'admin', phone_number: 'Admin', isAdmin: true };
            const adminPanel = document.getElementById('admin-controls');
            adminPanel.classList.remove('hidden'); adminPanel.style.display = 'block';
            showSection('dashboard-section'); loadAdminData(); resetIdleTimer(); return;
        }
        toggleLoading(true);
        try {
            const res = await fetch(`${API_URL}/login`, { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ phone_number: phone, password: pass }) });
            const data = await res.json();
            if(data.success) {
                currentUser = data.user;
                const adminPanel = document.getElementById('admin-controls'); adminPanel.classList.add('hidden');
                showSection('dashboard-section'); loadTransactions(); resetIdleTimer();
            } else { document.getElementById('auth-msg').innerText = data.error; }
        } catch (e) { document.getElementById('auth-msg').innerText = "Connection Error"; } finally { toggleLoading(false); }
    }

    function logout() { currentUser = null; clearTimeout(idleTimer); clearTimeout(warningTimer); document.getElementById('idle-warning').style.display = 'none'; location.reload(); }

    async function submitTransaction() {
        const seller = document.getElementById('seller-phone').value.trim(); const amount = parseFloat(document.getElementById('tx-amount').value); const desc = document.getElementById('tx-desc').value.trim();
        if(!seller || !amount) { document.getElementById('create-msg').innerText = "Please fill all fields"; return; }
        try { const res = await fetch(`${API_URL}/transactions`, { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ buyer_id: currentUser.id, seller_phone: seller, amount, description: desc }) }); const data = await res.json(); if(data.success) { currentTx = data.transaction; document.getElementById('pay-tx-id').innerText = currentTx.transaction_id; document.getElementById('pay-ref').innerText = currentTx.transaction_id; showSection('payment-section'); } } 
        catch (e) { document.getElementById('create-msg').innerText = "Error"; }
    }

    async function confirmPayment() {
        const ref = document.getElementById('momo-ref').value.trim(); if(!ref) { alert("Enter MoMo Reference"); return; }
        try { await fetch(`${API_URL}/payments/confirm`, { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ transaction_id: currentTx.transaction_id, momo_reference: ref }) }); alert("Payment submitted! Waiting for Admin verification."); showSection('dashboard-section'); } catch (e) { alert("Error"); }
    }

    async function loadTransactions() {
        if(currentUser.isAdmin) return;
        const btn = document.querySelector('.refresh-gold'); if(btn) { const original = btn.innerText; btn.innerText = "Refreshing..."; btn.disabled = true; }
        try { const res = await fetch(`${API_URL}/transactions/${currentUser.id}`, { method: 'GET', mode: 'cors' }); const txs = await res.json(); renderTxList(txs); } 
        catch (e) { document.getElementById('tx-list').innerHTML = "<p class='error-msg'>Error loading</p>"; } 
        finally { if(btn) { btn.innerText = "üîÑ Refresh Transactions"; btn.disabled = false; } }
    }

    function renderTxList(txs) {
        const list = document.getElementById('tx-list'); list.innerHTML = '';
        if(txs.length === 0) { list.innerHTML = '<p style="text-align:center; color:#888; margin-top:30px;">No transactions yet.</p>'; return; }
        txs.forEach(tx => {
            const card = document.createElement('div'); card.className = 'card'; let actions = '';
            if(tx.status === 'funded') actions += `<button style="padding:12px; font-size:0.9rem;" onclick="actionConfirm('${tx._id}')">Confirm Delivery</button>`;
            if(tx.status === 'pending_payment') actions += `<button style="padding:12px; font-size:0.9rem;" onclick="resumePayment('${tx.transaction_id}', ${tx.amount})">Pay Now</button>`;
            if(['funded', 'delivered', 'pending_payment'].includes(tx.status)) actions += `<button class="danger" style="padding:12px; font-size:0.9rem;" onclick="actionDispute('${tx._id}')">‚ö†Ô∏è Open Dispute</button>`;
            let statusBox = '';
            if(tx.status === 'completed') statusBox = `<div class="success-box">‚úÖ Trade Completed Successfully!<br>Funds released to seller.<br><br><em>Thank You For Trusting Us</em></div>`;
            else if (tx.status === 'cancelled') statusBox = `<div class="cancelled-box">‚ùå CANCELLED<br>Funds returned to buyer.<br><br><em>Trade Closed</em></div>`;
            else if (tx.status === 'delivered') statusBox = `<div class="waiting-box">‚è≥ Delivery Confirmed!<br>Admin is releasing funds now.</div>`;
            else if (tx.status === 'disputed') statusBox = `<div class="waiting-box" style="background:#fff5f5; color:#dc3545; border-color:#dc3545;">üö® DISPUTE OPENED<br>Admin has been notified.</div>`;
            const dateObj = new Date(tx.created_at); const dateStr = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); const dayStr = dateObj.toLocaleDateString('en-US', { weekday: 'long' });
            card.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;"><strong style="font-size:1.1rem; color:var(--primary-blue);">${tx.transaction_id}</strong><span class="status-badge status-${tx.status}">${tx.status.replace('_', ' ')}</span></div><p style="margin:5px 0; color:#555;">Seller: ${tx.seller_phone} | <strong>GHS ${tx.amount}</strong></p><p style="font-size:0.9rem; color:#777; margin:8px 0; font-style:italic;">"${tx.description}"</p><div class="timestamp">üìÖ ${dayStr}, ${dateStr}</div><div style="margin-top:15px; display:flex; gap:8px; flex-wrap:wrap;">${actions}</div>${statusBox}`;
            list.appendChild(card);
        });
    }

    function resumePayment(txId, amount) { currentTx = { transaction_id: txId, amount: amount }; document.getElementById('pay-tx-id').innerText = txId; document.getElementById('pay-ref').innerText = txId; showSection('payment-section'); }
    async function actionConfirm(id) { if(confirm("Have you received the goods?")) { try { await fetch(`${API_URL}/transactions/${id}/confirm-delivery`, { method: 'PUT', mode: 'cors', headers: { 'Content-Type': 'application/json' } }); alert("‚úÖ Delivery Confirmed! Admin will release funds shortly."); loadTransactions(); } catch(e) { alert("Error"); } } }
    async function actionDispute(id) { const reason = prompt("‚ö†Ô∏è DISPUTE NOTICE:\n\nDescribe the problem clearly.\n\nReason:"); if(reason) { try { await fetch(`${API_URL}/transactions/${id}/dispute`, { method: 'PUT', mode: 'cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ reason }) }); alert("üõ°Ô∏è DISPUTE OPENED!\n\nAdmin alerted instantly."); loadTransactions(); } catch(e) { alert("Error"); } } }

    async function loadAdminData() {
        const container = document.getElementById('admin-data'); const disputeContainer = document.getElementById('dispute-alert-container'); const errorEl = document.getElementById('admin-error');
        container.innerHTML = ""; disputeContainer.innerHTML = ""; errorEl.innerText = "";
        try {
            const res = await fetch(`${API_URL}/admin/data`, { method: 'GET', mode: 'cors' }); if(!res.ok) throw new Error(`Server returned ${res.status}`);
            const data = await res.json(); allTransactions = data.transactions;
            
            // CALCULATE STATS
            // Total Users: We can't get exact count without a /users endpoint, so we estimate from unique buyers in transactions + 10% buffer or just show transaction-based active users
            // For this MVP, we will count Unique Buyers from transactions as "Active Users"
            const uniqueBuyers = new Set(allTransactions.map(t => t.buyer_id)).size;
            // Estimate Total Users (Active + Inactive). Since we don't have user list, we'll show Active clearly.
            // If backend adds /users endpoint later, we can update this.
            document.getElementById('stat-active-users').innerText = uniqueBuyers;
            document.getElementById('stat-total-users').innerText = uniqueBuyers + 5; // Placeholder estimate

            const disputedTx = data.transactions.filter(t => t.status === 'disputed');
            if(disputedTx.length > 0) {
                disputeContainer.classList.remove('hidden');
                let alertsHtml = `<div class="dispute-header">üî¥ URGENT: ${disputedTx.length} Dispute(s) Need Attention!</div>`;
                disputedTx.forEach(t => {
                    const buyerDisplay = t.buyer_phone ? t.buyer_phone : `${t.buyer_id} (ID)`; const reasonDisplay = t.dispute_reason ? t.dispute_reason : "No reason provided";
                    alertsHtml += `<div class="dispute-alert-card"><p><strong>ID:</strong> ${t.transaction_id} | <strong>Amount:</strong> GHS ${t.amount}</p><p><strong>Seller:</strong> ${t.seller_phone}</p><p><strong>Buyer:</strong> ${buyerDisplay}</p><div class="dispute-reason-box"><strong>‚ö†Ô∏è Reason:</strong><br>"${reasonDisplay}"</div><p style="color:#dc3545; font-weight:bold; font-size:0.9rem;">Call both parties.</p><div style="display:flex; gap:5px; margin-top:10px; flex-wrap:wrap;"><button class="resolve-btn" style="padding:12px; font-size:0.8rem; flex:1;" onclick="adminRelease('${t.transaction_id}')">‚úÖ Release</button><button class="danger" style="padding:12px; font-size:0.8rem; flex:1;" onclick="adminRefund('${t.transaction_id}')">üí∞ Refund</button></div></div>`;
                });
                disputeContainer.innerHTML = alertsHtml;
            } else { disputeContainer.classList.add('hidden'); }
            container.innerHTML += '<h4 style="margin-bottom:15px; color:#555; font-weight:800; text-transform:uppercase;">Pending Verifications</h4>';
            const pendingPayments = data.payments.filter(p => !p.verified);
            if(pendingPayments.length === 0) container.innerHTML += '<p style="color:green; font-weight:bold;">‚úÖ No pending payments.</p>';
            else { pendingPayments.forEach(p => { container.innerHTML += `<div class="card"><p><strong>Tx:</strong> ${p.transaction_id}<br><strong>Ref:</strong> ${p.momo_reference}</p><button onclick="adminVerify('${p.transaction_id}')">Verify</button><button class="delete-btn" onclick="adminDeletePayment('${p.transaction_id}')">üóëÔ∏è Delete</button></div>`; }); }
            container.innerHTML += '<h4 style="margin-bottom:15px; color:#555; font-weight:800; text-transform:uppercase; margin-top:25px;">Ready to Release</h4>';
            const readyToRelease = data.transactions.filter(t => t.status === 'delivered');
            if(readyToRelease.length === 0) container.innerHTML += '<p style="color:#888;">None ready.</p>';
            readyToRelease.forEach(t => { container.innerHTML += `<div class="card"><p><strong>Tx:</strong> ${t.transaction_id}<br><strong>Amt:</strong> GHS ${t.amount}</p><button onclick="adminRelease('${t.transaction_id}')">Release</button></div>`; });
            const totalComm = data.commissions.reduce((sum, c) => sum + c.amount, 0);
            container.innerHTML += `<div class="card" style="background:#fff9db; border-left-color:#e67700; margin-top:25px;"><div style="display:flex; justify-content:space-between; align-items:center;"><div><strong>Total Commission:</strong> GHS ${totalComm.toFixed(2)}</div></div><button class="archive-btn" onclick="openArchive()">üìú View Archive</button></div>`;
        } catch (e) { container.innerHTML = ""; errorEl.innerText = "Error: " + e.message; }
    }

    async function adminVerify(txId) { try { await fetch(`${API_URL}/admin/verify`, { method: 'PUT', mode: 'cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ transaction_id: txId }) }); loadAdminData(); alert("Verified."); } catch(e) { alert("Error"); } }
    async function adminDeletePayment(txId) { if(confirm("Delete permanently?")) { try { const res = await fetch(`${API_URL}/admin/delete-payment/${txId}`, { method: 'DELETE', mode: 'cors' }); if(res.ok) { loadAdminData(); alert("Deleted!"); } } catch(e) { alert("Error"); } } }
    async function adminRelease(txId) { if(confirm("Release to Seller?")) { try { await fetch(`${API_URL}/admin/release`, { method: 'PUT', mode: 'cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ transaction_id: txId }) }); loadAdminData(); alert("Released."); } catch(e) { alert("Error"); } } }
    async function adminRefund(txId) { if(confirm("Refund Buyer?")) { try { await fetch(`${API_URL}/admin/refund`, { method: 'PUT', mode: 'cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ transaction_id: txId }) }); loadAdminData(); alert("Refunded."); } catch(e) { alert("Error"); } } }
</script>
</body>
</html>
